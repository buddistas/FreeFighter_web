# Исправление логики циклов боя

## Проблема

BodyHunter и LegHunter механически идентичны, но показывали разные результаты. Пользователь правильно указал, что **порядок хода не должен влиять на результат**, так как бой делится на циклы, где каждый боец и атакует, и защищается.

## Найденная проблема

В оригинальной реализации проверка окончания боя происходила **после каждой фазы**, а не после полного цикла (двух фаз). Это создавало предвзятость:

1. Фаза 1: Fighter1 атакует → проверка окончания
2. Если Fighter2 достиг 0 HP, бой заканчивался **ДО** того, как Fighter2 успевал атаковать
3. Это давало преимущество тому, кто атакует первым

## Правильная логика (как в оригинальной игре)

Согласно `game.js` (строки 448-451), проверка окончания происходит **только после завершения обеих фаз цикла**:

```javascript
// Проверяем окончание раунда (после второй фазы isPlayerAttacking становится true)
if (this.isPlayerAttacking) {
    // Раунд завершен (обе фазы выполнены), проверяем условия победы
    this.checkGameEnd();
}
```

**Правильная механика:**
- Цикл = 2 фазы
- Фаза 1: Fighter1 атакует, Fighter2 защищается
- Фаза 2: Fighter2 атакует, Fighter1 защищается
- **Только после обеих фаз** проверяется окончание боя
- Даже если боец достиг 0 HP в первой фазе, он все равно проводит вторую фазу (атаку)

## Исправление

Изменена логика в `Fight.simulate()` и `Fight.simulateTieRound()`:

**Было:**
- Выполняется одна фаза
- Проверка окончания боя
- Переключение ролей
- Следующая фаза

**Стало:**
- Выполняется фаза 1 (Fighter1 атакует)
- Выполняется фаза 2 (Fighter2 атакует) - **даже если кто-то достиг 0 HP**
- **Только после обеих фаз** проверка окончания боя
- Следующий цикл

## Результаты исправления

**До исправления:**
- BodyHunter vs LegHunter: BodyHunter выигрывал 64.02%
- LegHunter vs BodyHunter: LegHunter выигрывал 63.76%
- Разница: **24.46%** в зависимости от порядка

**После исправления:**
- BodyHunter: 41.20%
- LegHunter: 42.24%
- Разница: **1.04%** (статистическая вариация)

## Вывод

После исправления логики циклов BodyHunter и LegHunter показывают **практически одинаковые результаты** (разница 1.04%), что соответствует их механической идентичности. Порядок хода больше не влияет на результат, так как каждый цикл симметричен.

